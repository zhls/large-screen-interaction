# BI 数据讲解：实时解读业务指标与趋势 - 开发文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 项目名称 | BI 数据讲解：实时解读业务指标与趋势 |
| 赛道 | 大屏交互与智能讲解 |
| 方向 | BI 数据讲解：实时解读业务指标与趋势 |
| 文档版本 | v1.2 |
| 创建日期 | 2025-12-29 |
| 最后更新 | 2025-12-29 |

---

## 目录

1. [项目进度](#项目进度)
2. [项目简介](#项目简介)
3. [技术栈](#技术栈)
4. [技术架构](#技术架构)
5. [目录结构](#目录结构)
6. [环境配置](#环境配置)
7. [核心功能实现](#核心功能实现)
8. [API接口文档](#api接口文档)

---

## 项目进度

### 已完成 ✅

| 任务 | 状态 | 说明 |
|------|------|------|
| 项目初始化 | ✅ | 前后端一体化架构搭建 |
| 基础配置文件 | ✅ | package.json, tsconfig.json, vite.config.ts |
| 密钥配置页面 | ✅ | ApiKeyConfig 组件（localStorage存储） |
| 数字人连接控制 | ✅ | avatarStore + AvatarController + AvatarContainer |
| 大屏布局设计 | ✅ | DashboardLayout（响应式全屏布局） |
| AI数据生成服务 | ✅ | 使用魔搭AI动态生成模拟业务数据 |
| 场景切换功能 | ✅ | 常规运营/营销活动/销售淡季/特殊事件4种场景 |
| 数据可视化组件 | ✅ | MetricCard, TrendChart, BarChart, PieChart, GaugeChart |
| 地区/产品图表 | ✅ | RegionalChart, ProductChart |
| 进度条效果 | ✅ | 40秒AI生成进度可视化 |
| API接口开发 | ✅ | /api/data/generate, /api/chat/stream |
| 前端对接API | ✅ | 完整的数据生成和展示流程 |
| AI数据解读 | ✅ | 自动生成洞察和建议 |
| 智能对话功能 | ✅ | 流式对话 + 降级响应 |
| 数字人播报 | ✅ | 自动播报 + 手动播报 |
| 布局优化 | ✅ | 数字人右侧布局（占2/6宽度），内容区占4/6 |
| 样式更新 | ✅ | 全新的界面风格和图表布局 |

---

## 项目简介

### 项目描述

基于魔珐星云3D数字人技术，打造一个能够实时解读企业BI业务数据指标与趋势的智能讲解系统。通过数字人配合大屏数据可视化，为管理者提供直观、智能的业务洞察。

### 应用场景

- **企业展厅/指挥中心**：向访客实时讲解企业运营状况
- **数据汇报会议**：智能解读关键业务指标
- **运营监控大屏**：自动播报数据异常和趋势预警
- **投资者演示**：生动展示企业成长数据

### 核心功能

| 功能 | 描述 |
|------|------|
| **AI数据生成** | 使用魔搭AI (DeepSeek-V3.2) 动态生成7个核心指标+地区数据+产品数据 |
| **场景切换** | 5种预设场景（正常/促销/淡季/异常/自定义） |
| **智能对话** | AI助手基于当前数据回答业务问题 |
| **语音播报** | 数字人自动/手动播报数据摘要 |
| **多视图切换** | 运营总览/区域分析/产品表现/AI对话4种视图 |

### 技术亮点

- **AI驱动数据**：使用魔搭社区大模型生成真实业务数据
- **双模态交互**：语音播报 + 文字对话
- **智能降级**：AI失败时自动使用增强生成器
- **流式响应**：对话采用SSE流式传输
- **大屏适配**：自动缩放适配不同屏幕尺寸
- **状态管理**：Zustand轻量级状态管理

---

## 技术栈

### 前端技术栈

```yaml
框架: React 18.x + TypeScript
构建工具: Vite 5.x
状态管理: Zustand
样式方案: TailwindCSS
HTTP客户端: Axios
图表可视化: ECharts 5.x
大屏适配: vw/vh 单位 + Scale缩放
```

### 后端技术栈

```yaml
运行环境: Node.js 18.x
框架: Express + TypeScript
AI服务: 魔搭社区 (ModelScope)
对话模型: deepseek-ai/DeepSeek-V3.2
数据处理:
  - 场景化数据生成
  - 趋势分析
  - 异常检测
```

### 具身驱动SDK

```yaml
SDK名称: 魔珐星云具身驱动SDK
版本: 0.1.0-alpha.45
接入方式: JavaScript CDN
```

---

## 技术架构

### 系统架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                          客户端层 (Browser)                         │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  React UI    │  │  星云SDK层   │  │  状态管理    │             │
│  │              │  │              │  │  (Zustand)   │             │
│  │ - 场景切换   │  │ - 3D数字人   │◄─┤              │             │
│  │ - 视图切换   │  │ - 语音合成   │  │ - 对话历史   │             │
│  │ - 播报控制   │  │ - 连接控制   │  │ - 数据状态   │             │
│  │ - 进度条     │  │ - 状态监控   │  │ - 密钥配置   │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                    ECharts 数据可视化层                     │     │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │     │
│  │  │ 折线图   │ │ 柱状图   │ │ 饼图     │ │ 仪表盘   │      │     │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │     │
│  └────────────────────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ HTTP/WebSocket
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                          服务端层 (Node.js)                         │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  API服务     │  │  AI服务      │  │  数据分析     │             │
│  │  (Express)   │  │  (魔搭)      │  │  (生成器)    │             │
│  │              │  │              │  │              │             │
│  │ - /data      │─►│ - 数据生成   │◄─│ - AI生成     │             │
│  │ - /chat      │  │ - 对话回复   │  │ - 增强生成   │             │
│  │ - /scenarios │  │ - 流式响应   │  │ - 降级处理   │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└────────────────────────────────────────────────────────────────────┘
```

### 数据流图

```
用户选择场景
    │
    ▼
┌──────────────────┐
│  场景切换器       │
│  (带进度条)      │
└────┬─────────────┘
     │ 1. 发起数据生成请求
     ▼
┌─────────────────────┐
│  后端API            │
│  /api/data/generate │
└────┬────────────────┘
     │ 2. 尝试AI生成（120秒超时）
     ▼
┌─────────────────────┐     ┌──────────────┐
│  魔搭AI             │────►│ 失败时降级   │
│  DeepSeek-V3.2     │     │ 增强生成器   │
└────┬────────────────┘     └──────────────┘
     │ 3. 返回完整数据
     ▼
┌─────────────────────┐
│  数据展示           │
│  - 7个指标卡片      │
│  - 趋势图           │
│  - 地区分布图       │
│  - 产品分类图       │
└────┬────────────────┘
     │ 4. 数字人播报洞察
     ▼
┌─────────────────────┐
│  数字人播报         │
│  自动播报 + 手动播报│
└─────────────────────┘
```

---

## 目录结构

```
large-screen-interaction/
├── src/                         # 源代码目录
│   ├── client/                  # 前端代码 (React + TypeScript)
│   │   ├── components/
│   │   │   ├── Avatar/          # 数字人组件
│   │   │   │   ├── AvatarController.ts      # SDK控制器
│   │   │   │   └── AvatarContainer.tsx      # 数字人容器
│   │   │   ├── Chat/            # 对话组件
│   │   │   │   └── ChatBox.tsx              # AI对话框
│   │   │   ├── Config/          # 配置组件
│   │   │   │   └── ApiKeyConfig.tsx         # 密钥配置页
│   │   │   ├── Data/            # 数据组件
│   │   │   │   └── ScenarioSwitcher.tsx     # 场景切换器
│   │   │   ├── Dashboard/       # 大屏组件
│   │   │   │   ├── DashboardLayout.tsx      # 大屏布局
│   │   │   │   ├── MetricCard.tsx           # 指标卡片
│   │   │   │   ├── TrendChart.tsx           # 趋势图
│   │   │   │   ├── RegionalChart.tsx        # 地区图表
│   │   │   │   └── ProductChart.tsx         # 产品图表
│   │   │   └── Chart/           # 图表组件
│   │   │       ├── index.ts                 # 图表导出
│   │   │       ├── BarChart.tsx             # 柱状图
│   │   │       ├── LineChart.tsx            # 折线图
│   │   │       ├── PieChart.tsx             # 饼图
│   │   │       └── GaugeChart.tsx           # 仪表盘
│   │   ├── store/                # 状态管理
│   │   │   ├── keyStore.ts        # 密钥状态
│   │   │   └── avatarStore.ts     # 数字人状态
│   │   ├── services/             # 服务层
│   │   │   ├── keyService.ts      # 密钥管理
│   │   │   └── dataService.ts     # 数据服务
│   │   └── App.tsx               # 主应用
│   │
│   ├── server/                   # 后端代码 (Node.js + TypeScript)
│   │   ├── routes/               # API路由
│   │   │   ├── data.routes.ts    # 数据生成路由
│   │   │   └── chat.routes.ts    # 对话路由
│   │   └── services/             # 业务服务
│   │       ├── aiDataGenerator.ts     # AI数据生成服务
│   │       ├── enhancedDataGenerator.ts # 增强数据生成
│   │       └── chatService.ts         # 对话服务
│   │
│   └── shared/                   # 共享代码
│       └── types/               # 共享类型定义
│
├── data/                        # 数据文件
│   ├── knowledge/               # 知识库数据（可选）
│   └── mock/                    # 模拟业务数据配置
│
├── public/                      # 静态资源
├── package.json                 # 项目配置
├── vite.config.ts              # Vite配置
├── tsconfig.json               # TypeScript配置
├── tsconfig.server.json        # TypeScript配置 (后端)
└── .env.server                 # 后端环境变量
```

---

## 环境配置

### 前端环境配置

密钥由用户在页面输入，不需要配置环境变量。

### 后端环境配置

**.env.server**
```bash
# 服务器配置
PORT=5173
NODE_ENV=development

# AI模型配置
MODELSCOPE_MODEL=deepseek-ai/DeepSeek-V3.2
EMBEDDING_MODEL=Qwen/Qwen3-Embedding-8B
```

---

## 核心功能实现

### 1. AI数据生成

#### 数据结构

```typescript
interface AIGeneratedData {
  metrics: MetricData[];        // 7个核心指标
  trend: TrendPoint[];         // 12小时趋势数据
  regionalData: RegionalData[]; // 4个地区数据
  productData: ProductData[];   // 4个产品数据
  insight: string;             // 数据洞察
  suggestion: string;          // 业务建议
}
```

#### 7个核心指标

1. **营业收入** (元)：企业总收入
2. **订单量** (单)：订单总数
3. **毛利率** (%)：盈利能力指标
4. **活跃用户** (人)：用户活跃度
5. **转化率** (%)：转化效果
6. **客单价** (元)：平均订单金额
7. **复购率** (%)：客户忠诚度

#### 地区数据

- 华东区、华南区、华北区、西部区
- 每个地区包含：营收、增长率

#### 产品数据

- 电子产品、家居用品、服装服饰、食品饮料
- 每个产品包含：营收、毛利率、市场份额

### 2. 场景切换

**4种预设场景：**

| 场景 | 代码 | 数据特征 |
|------|------|----------|
| 常规运营 | `normal` | 业务平稳发展，各项核心指标保持小幅合理波动 |
| 营销活动 | `promotion` | 大型促销活动开展，市场响应积极，核心指标显著增长 |
| 销售淡季 | `off_season` | 市场需求相对低迷，关键指标呈现适度下滑趋势 |
| 特殊事件 | `anomaly` | 突发事件影响，业务数据出现异常波动状况 |

**进度条：**
- 每100ms增加0.25%
- 40秒完成
- 显示百分比和预计剩余时间

### 3. 智能对话

**系统提示词包含：**
- 当前场景信息
- 7个核心指标详情
- 地区数据
- 产品数据
- 数据洞察
- 业务建议
- 预警信息
- 营收趋势

**快捷问题：**
- 营收如何？
- 如何提高转化率？
- 哪个地区表现最好？
- 什么产品营收最高？
- 毛利率下降的原因是什么？
- 有哪些预警吗？

**降级响应：**
- 关键词匹配
- 支持所有指标的查询
- 支持地区、产品、预警查询

### 4. 数字人播报

**自动播报：**
- 数据生成完成后自动触发
- 播报内容：数据更新完毕 + 数据洞察

**手动播报：**
- 点击"开始播报"按钮
- 播报内容包括：
  - 营业收入（数值+变化）
  - 毛利率（数值+变化）
  - 活跃用户（数值+变化）
  - 订单量（数值+变化）
  - 最多2条预警
  - 数据洞察
  - 业务建议（第一句）

### 5. 视图切换

**4种视图模式：**
| 视图 | 内容 |
|------|------|
| 运营总览 | 区域营收对比分析 + 产品类别营收占比 + 12小时营收趋势分析 + 智能数据分析 |
| 区域分析 | 区域营收对比 + 区域增长率分析 |
| 产品表现 | 各产品类别营收 + 各产品类别毛利率分析 |
| 实时问答 | AI对话 |

---

## API接口文档

### POST /api/data/generate

**功能**：生成业务数据

**请求头**：
```
Content-Type: application/json
x-modelscope-api-key: {魔搭API密钥}
```

**请求体**：
```json
{
  "scenario": "normal",
  "useAI": true,
  "previousData": {
    "metrics": [...]
  }
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "metrics": [
      {
        "name": "营业收入",
        "value": 5280000,
        "previousValue": 4800000,
        "change": 480000,
        "changePercent": 10.00,
        "unit": "元",
        "trend": "up"
      }
      // ... 共7个指标
    ],
    "trend": [
      {"timestamp": 1703500000000, "value": 5000000}
      // ... 共12个数据点
    ],
    "regionalData": [
      {"name": "华东区", "value": 1800000, "changePercent": 12.50}
      // ... 共4个地区
    ],
    "productData": [
      {"name": "电子产品", "revenue": 2300000, "margin": 28.50, "share": 45.00}
      // ... 共4个品类
    ],
    "insight": "本期业务运行平稳...",
    "suggestion": "建议持续关注核心指标...",
    "alerts": [
      {"level": "warning", "message": "毛利率低于30%"}
    ]
  },
  "source": "ai"
}
```

### POST /api/chat/stream

**功能**：流式对话

**请求头**：
```
Content-Type: application/json
x-modelscope-api-key: {魔搭API密钥}
```

**请求体**：
```json
{
  "message": "营收如何？",
  "conversationHistory": [
    {"role": "user", "content": "上一条消息"},
    {"role": "assistant", "content": "上一条回复"}
  ],
  "currentData": {
    "metrics": [...],
    "regionalData": [...],
    "productData": [...],
    "insight": "...",
    "suggestion": "...",
    "alerts": [...]
  }
}
```

**响应流**：
```
data: {"type":"content","data":"当前"}
data: {"type":"content","data":"营业收入"}
data: {"type":"content","data":"为"}
data: {"type":"content","data":"528万"}
data: {"type":"end"}
```

### GET /api/data/scenarios

**功能**：获取可用场景列表

**响应**：
```json
{
  "success": true,
  "scenarios": [
    {"value": "normal", "label": "常规运营", "description": "业务稳健推进，各项核心指标保持小幅合理波动"},
    {"value": "promotion", "label": "营销活动", "description": "大型促销活动开展，市场响应积极，核心指标显著增长"},
    {"value": "off_season", "label": "销售淡季", "description": "市场需求相对低迷，关键指标呈现适度下滑趋势"},
    {"value": "anomaly", "label": "特殊事件", "description": "突发事件影响，业务数据出现异常波动状况"}
  ]
}
```

---

## 开发注意事项

### 数据精度

- 所有百分比保留2位小数
- 金额使用整数（元）
- 人数使用整数（人）

### AI配置

- 模型：`deepseek-ai/DeepSeek-V3.2`
- 超时时间：120秒（2分钟）
- 温度：0.8（数据生成）、0.7（对话）
- 最大Token：2000（数据生成）、1000（对话）

### 数字人SDK

- 需要有效的网络连接
- App ID和App Secret从星云控制台获取
- 支持手动连接/断开

### 大屏适配

- 设计尺寸：1920x1080
- 使用scale缩放适配
- 数字人固定在屏幕右侧，占2/6宽度（约33.33%），高度占所在区域的4/5
- 内容区域占4/6宽度，采用网格布局

---

*文档版本: v1.2 | 最后更新: 2025-12-29*
